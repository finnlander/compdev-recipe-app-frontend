<div class="wrapper">
  <h2>{{ mode | titlecase }} recipe</h2>
  <form (ngSubmit)="onSubmit()" [formGroup]="form">
    <!-- recipe fields -->
    <div class="details-wrapper">
      <mat-form-field class="details-row">
        <mat-label>Name</mat-label>
        <input matInput type="text" formControlName="name" />
      </mat-form-field>
      <mat-form-field class="details-row">
        <mat-label>Description</mat-label>
        <textarea
          matInput
          type="text"
          formControlName="description"
          rows="3"
        ></textarea>
      </mat-form-field>
      <mat-form-field class="details-row">
        <mat-label>Image URL</mat-label>
        <input
          matInput
          type="url"
          placeholder="https://"
          formControlName="imageUrl"
          #imageUrl
        />
      </mat-form-field>
      <div class="details-row">
        <img class="shadowed" [src]="imageUrl.value" alt="[recipe image]" />
      </div>
    </div>

    <hr />
    <!-- phases -->
    <div>
      <h4>Cooking Phases</h4>
      <mat-slide-toggle
        class="slide-toggle"
        name="usePhases"
        formControlName="usePhases"
        >Divide recipe into phases</mat-slide-toggle
      >
      <ng-container *ngIf="usePhases">
        <div class="flex-wrapper">
          <mat-form-field>
            <mat-label>Phase name</mat-label>
            <input
              matInput
              type="text"
              formControlName="newPhaseName"
              placeholder="phase name"
            />
          </mat-form-field>
          <div>
            <app-action-button
              text="Add"
              icon="add"
              [disabled]="!canAddPhase()"
              tooltip="Add new phase"
              (clicked)="onAddPhase()"
            ></app-action-button>
          </div>
        </div>
        <div class="gutter"></div>
        <ng-container *ngIf="phases.length > 0" formArrayName="phases">
          <h4>Phases:</h4>
          <mat-list cdkDropList (cdkDropListDropped)="onPhaseDrop($event)">
            <mat-list-item
              class="phase-list-item"
              *ngFor="let phaseControl of phases.controls; let i = index"
              cdkDrag
            >
              <div class="flex-wrapper">
                <div class="phase-drag-placeholder" *cdkDragPlaceholder></div>
                <button
                  mat-icon-button
                  type="button"
                  title="move order"
                  cdkDragHandle
                >
                  <mat-icon>drag_handle</mat-icon>
                </button>
                <div class="flex-grow ellipsis-text">
                  {{ phaseControl.value }}
                </div>
                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  [disabled]="!canDeletePhase(phaseControl.value)"
                  [title]="
                    canDeletePhase(phaseControl.value)
                      ? 'Delete'
                      : '(phase is in use)'
                  "
                  (click)="onDeletePhase(i)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </mat-list-item>
          </mat-list>

          <hr />
        </ng-container>
      </ng-container>
    </div>
    <!-- ingredients -->
    <div>
      <h4>Ingredients</h4>
      <app-action-button
        text="Add ingredient"
        icon="add"
        (clicked)="onAddOrEditIngredient()"
      ></app-action-button>

      <mat-list>
        <!-- without phases-->
        <ng-container *ngIf="!usePhases">
          <ng-container *ngFor="let ingredientItem of ingredientItems">
            <app-ingredient-item
              [item]="ingredientItem"
              (deleted)="onDeleteIngredient(ingredientItem)"
            ></app-ingredient-item>
          </ng-container>
        </ng-container>

        <!-- with phases -->
        <ng-container *ngIf="usePhases">
          <ng-container
            *ngFor="
              let unassignedItem of ingredientsWithoutPhases;
              let first = first;
              let last = last
            "
          >
            <div *ngIf="first" mat-subheader class="ingredient-phase">
              no phase assigned:
            </div>
            <app-ingredient-item
              [item]="unassignedItem"
              (clicked)="onAddOrEditIngredient($event)"
              (deleted)="onDeleteIngredient($event)"
            ></app-ingredient-item>
            <mat-divider
              *ngIf="last"
              class="ingredient-phase-divider"
            ></mat-divider>
          </ng-container>
          <ng-container *ngFor="let phase of form.value.phases">
            <div *ngIf="phase" mat-subheader class="ingredient-phase">
              {{ phase }}
            </div>
            <ng-template
              #ingredients
              let-phaseIngredients
              [ngTemplateOutlet]="ingredients"
              [ngTemplateOutletContext]="{
                $implicit: getIngredientItems(phase)
              }"
            >
              <app-ingredient-item
                *ngFor="let ingredientItem of phaseIngredients"
                [item]="ingredientItem"
                (clicked)="onAddOrEditIngredient($event)"
                (deleted)="onDeleteIngredient($event)"
              ></app-ingredient-item>

              <mat-divider
                *ngIf="phase"
                class="ingredient-phase-divider"
              ></mat-divider>
            </ng-template>
          </ng-container>
        </ng-container>
      </mat-list>
    </div>
    <hr />
    <!-- form buttons -->
    <div class="form-buttons">
      <button
        mat-raised-button
        class="form-button"
        color="primary"
        type="submit"
        [disabled]="!canSave()"
      >
        Save
      </button>
      <button
        mat-raised-button
        class="form-button"
        type="button"
        (click)="onCancel()"
      >
        Cancel
      </button>
    </div>
  </form>
</div>
